<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title></title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src='//api.tiles.mapbox.com/mapbox-gl-js/v0.11.2/mapbox-gl.js'></script>
	<script src='//cdnjs.cloudflare.com/ajax/libs/dat-gui/0.5.1/dat.gui.min.js'></script>
    <link href='//api.tiles.mapbox.com/mapbox-gl-js/v0.11.2/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
    </style>
</head>
<body>

<div id='map'></div>
<script>
	var FilterConfig = function() {
		this.debug_type = "permissions";

		this.show_unused = false;
		this.color_unused = "#b013b5";
		this.show_bike_path = false;
		this.color_bike_path = "#999f7c";
		this.show_sidewalk = false;
		this.color_sidewalk = "#367f74";
		this.show_crossing = false;
		this.color_crossing = "#682cab";
		this.show_roundabout = false;
		this.color_roundabout = "#21c021";
		this.show_elevator = false;
		this.color_elevator = "#8c6023";
		this.show_stairs = false;
		this.color_stairs = "#0e2e8c";
		this.show_platform = false;
		this.color_platform = "#0c5611";
		this.show_bogus_name = false;
		this.color_bogus_name = "#cb098f";
		this.show_no_thru_traffic = false;
		this.color_no_thru_traffic = "#b56031";
		this.show_slope_override = false;
		this.color_slope_override = "#f5627b";
		this.show_transit_link = false;
		this.color_transit_link = "#8448d3";
		this.show_allows_pedestrian = true;
		this.color_allows_pedestrian = "#affe1b";
		this.show_allows_bike = false;
		this.color_allows_bike = "#5b82fd";
		this.show_allows_car = false;
		this.color_allows_car = "#006d93";
		this.show_allows_wheelchair = false;
		this.color_allows_wheelchair = "#505bc3";
		this.show_bike_lts_1 = false;
		this.color_bike_lts_1 = "#fa9de1";
		this.show_bike_lts_2 = false;
		this.color_bike_lts_2 = "#d2a18c";
		this.show_bike_lts_3 = false;
		this.color_bike_lts_3 = "#f3df6a";
		this.show_bike_lts_4 = false;
		this.color_bike_lts_4 = "#a45189";
	};
	var text = new FilterConfig();
	var gui = new dat.GUI();
	gui.add(text, 'debug_type', ['permissions', 'flags', 'speeds']).onFinishChange(getStyle);


var allows_pedestrian = gui.addFolder('Allows Pedestrian');
    allows_pedestrian.add(text,
    'show_allows_pedestrian').onFinishChange(function(value) {flagChange('allows_pedestrian', value)});
    allows_pedestrian.addColor(text, 'color_allows_pedestrian').onChange(function(color) {colorChange('allows_pedestrian', color)});

var allows_bike = gui.addFolder('Allows Bike');
    allows_bike.add(text,
    'show_allows_bike').onFinishChange(function(value) {flagChange('allows_bike', value)});
    allows_bike.addColor(text, 'color_allows_bike').onChange(function(color) {colorChange('allows_bike', color)});

var allows_car = gui.addFolder('Allows Car');
    allows_car.add(text,
    'show_allows_car').onFinishChange(function(value) {flagChange('allows_car', value)});
    allows_car.addColor(text, 'color_allows_car').onChange(function(color) {colorChange('allows_car', color)});

var allows_wheelchair = gui.addFolder('Allows Wheelchair');
    allows_wheelchair.add(text,
    'show_allows_wheelchair').onFinishChange(function(value) {flagChange('allows_wheelchair', value)});
    allows_wheelchair.addColor(text, 'color_allows_wheelchair').onChange(function(color) {colorChange('allows_wheelchair', color)});

var bike_lts_1 = gui.addFolder('Bike Lts 1');
    bike_lts_1.add(text,
    'show_bike_lts_1').onFinishChange(function(value) {flagChange('bike_lts_1', value)});
    bike_lts_1.addColor(text, 'color_bike_lts_1').onChange(function(color) {colorChange('bike_lts_1', color)});

var bike_lts_2 = gui.addFolder('Bike Lts 2');
    bike_lts_2.add(text,
    'show_bike_lts_2').onFinishChange(function(value) {flagChange('bike_lts_2', value)});
    bike_lts_2.addColor(text, 'color_bike_lts_2').onChange(function(color) {colorChange('bike_lts_2', color)});

var bike_lts_3 = gui.addFolder('Bike Lts 3');
    bike_lts_3.add(text,
    'show_bike_lts_3').onFinishChange(function(value) {flagChange('bike_lts_3', value)});
    bike_lts_3.addColor(text, 'color_bike_lts_3').onChange(function(color) {colorChange('bike_lts_3', color)});

var bike_lts_4 = gui.addFolder('Bike Lts 4');
    bike_lts_4.add(text,
    'show_bike_lts_4').onFinishChange(function(value) {flagChange('bike_lts_4', value)});
    bike_lts_4.addColor(text, 'color_bike_lts_4').onChange(function(color) {colorChange('bike_lts_4', color)});
	
	var unused = gui.addFolder('Unused');
    unused.add(text,
    'show_unused').onFinishChange(function(value) {flagChange('unused', value)});
    unused.addColor(text, 'color_unused').onChange(function(color) {colorChange('unused', color)});

var bike_path = gui.addFolder('Bike Path');
    bike_path.add(text,
    'show_bike_path').onFinishChange(function(value) {flagChange('bike_path', value)});
    bike_path.addColor(text, 'color_bike_path').onChange(function(color) {colorChange('bike_path', color)});

var sidewalk = gui.addFolder('Sidewalk');
    sidewalk.add(text,
    'show_sidewalk').onFinishChange(function(value) {flagChange('sidewalk', value)});
    sidewalk.addColor(text, 'color_sidewalk').onChange(function(color) {colorChange('sidewalk', color)});

var crossing = gui.addFolder('Crossing');
    crossing.add(text,
    'show_crossing').onFinishChange(function(value) {flagChange('crossing', value)});
    crossing.addColor(text, 'color_crossing').onChange(function(color) {colorChange('crossing', color)});

var roundabout = gui.addFolder('Roundabout');
    roundabout.add(text,
    'show_roundabout').onFinishChange(function(value) {flagChange('roundabout', value)});
    roundabout.addColor(text, 'color_roundabout').onChange(function(color) {colorChange('roundabout', color)});

var elevator = gui.addFolder('Elevator');
    elevator.add(text,
    'show_elevator').onFinishChange(function(value) {flagChange('elevator', value)});
    elevator.addColor(text, 'color_elevator').onChange(function(color) {colorChange('elevator', color)});

var stairs = gui.addFolder('Stairs');
    stairs.add(text,
    'show_stairs').onFinishChange(function(value) {flagChange('stairs', value)});
    stairs.addColor(text, 'color_stairs').onChange(function(color) {colorChange('stairs', color)});

var platform = gui.addFolder('Platform');
    platform.add(text,
    'show_platform').onFinishChange(function(value) {flagChange('platform', value)});
    platform.addColor(text, 'color_platform').onChange(function(color) {colorChange('platform', color)});

var bogus_name = gui.addFolder('Bogus Name');
    bogus_name.add(text,
    'show_bogus_name').onFinishChange(function(value) {flagChange('bogus_name', value)});
    bogus_name.addColor(text, 'color_bogus_name').onChange(function(color) {colorChange('bogus_name', color)});

var no_thru_traffic = gui.addFolder('No Thru Traffic');
    no_thru_traffic.add(text,
    'show_no_thru_traffic').onFinishChange(function(value) {flagChange('no_thru_traffic', value)});
    no_thru_traffic.addColor(text, 'color_no_thru_traffic').onChange(function(color) {colorChange('no_thru_traffic', color)});

var slope_override = gui.addFolder('Slope Override');
    slope_override.add(text,
    'show_slope_override').onFinishChange(function(value) {flagChange('slope_override', value)});
    slope_override.addColor(text, 'color_slope_override').onChange(function(color) {colorChange('slope_override', color)});

var transit_link = gui.addFolder('Transit Link');
    transit_link.add(text,
    'show_transit_link').onFinishChange(function(value) {flagChange('transit_link', value)});
    transit_link.addColor(text, 'color_transit_link').onChange(function(color) {colorChange('transit_link', color)});

	//String startsWith polyfill
	if (!String.prototype.startsWith) {
		String.prototype.startsWith = function(searchString, position) {
			position = position || 0;
			return this.indexOf(searchString, position) === position;
		};
	}

	

function clone(obj) {
    var copy;

    // Handle the 3 simple types, and null or undefined
    if (null == obj || "object" != typeof obj) return obj;

    // Handle Date
    if (obj instanceof Date) {
        copy = new Date();
        copy.setTime(obj.getTime());
        return copy;
    }

    // Handle Array
    if (obj instanceof Array) {
        copy = [];
        for (var i = 0, len = obj.length; i < len; i++) {
            copy[i] = clone(obj[i]);
        }
        return copy;
    }

    // Handle Object
    if (obj instanceof Object) {
        copy = {};
        for (var attr in obj) {
            if (obj.hasOwnProperty(attr)) copy[attr] = clone(obj[attr]);
        }
        return copy;
    }

    throw new Error("Unable to copy obj! Its type isn't supported.");
}

var otp_config = {
	hostname: "http://localhost:8080",
	restService: "debug",
	routerId: "default"
};
//Those are layers and name of properties in a layer if detail=true
var layers = {
	streetEdges:["edge_id", "permission", "speed", "flags"],
	permEdges:["name", "edge_id", "label"]
};
var current_layer = "streetEdges";
var url = otp_config.hostname + '/' + otp_config.restService;
var style;
var current_type="permissions";
var request_url = url+'/' + current_layer;

var permission_colors = {
	"none":"#333333",
	"walk":"#33b333",
	"bike":"#3333b3",
	"walk,bike":"#33b3b3",
	"car":"#b33333",
	"walk,car":"#b3b333",
	"bike,car":"#b333b3",
	"walk,bike,car":"#b3b3b3"
	};

/**
Function enables or disables layer depending on true or false gui value
**/
function flagChange(flag_name, value) {
	if (current_type != "flags") {
		return;
	}
	//console.log("Flag:", flag_name);
	//console.log("Info:", value);
	if (value == false) {
		map.removeLayer("perm-"+flag_name);
	} else {
		var flag_layer = {
			"id": "perm-"+flag_name,
			"type": "line",
			"source": "perm",
			"paint": {
				"line-color":text["color_"+flag_name],
				"line-width":2
			},
			"filter":["==", flag_name.toUpperCase(), true]
		};
		map.addLayer(flag_layer);
	}
}

//Function changes color of specific flag during changing color in gui
function colorChange(name, color) {
	if (current_type != "flags") {
		return;
	}
	//It is assumed that layer exists since it is enabled
	if(text["show_"+name] == true) {
		//console.log("Flag:", name);
		//console.log("color:", color);
		map.setPaintProperty("perm-"+name, "line-color", color);
	}
}

//Switches Mapbox GL style between permissions and viewing specific flags
function getStyle(type) {
	console.info(type);
	console.log(text);
	style = clone(mapbox_style);
	style.sources["perm"].data = full_url;
	if (type == "permissions") {
		$.each(permission_colors, function(name, color) {
			var nice_name = name.replace(',', '_');
			var permission_layer = {
				"id": "perm-"+nice_name,
				"type": "line",
				"source": "perm",
				"paint": {
					"line-color":color,
					"line-width":2
				},
				"interactive": true,
				"filter":["==", "permission", name]
			};
			style.layers.push(permission_layer);
		});
		var hover_layer = {
		"id": "perm-hover",
		"type": "line",
		"source": "perm",
		"paint": {
			"line-color":"red",
			"line-width":2
		},
		"filter": ["==", "edge_id", -1]
		};
		style.layers.push(hover_layer);
	} else if (type == "flags") {
		$.each(text, function(name, value) {
			console.log(name);
			if (name.startsWith("show_") && value == true) {
				var flag_name = name.replace("show_", "");
				var flag_layer = {
					"id": "perm-"+flag_name,
					"type": "line",
					"source": "perm",
					"paint": {
						"line-color":text["color_"+flag_name],
						"line-width":2
					},
					"filter":["==", flag_name.toUpperCase(), true]
				};
				style.layers.push(flag_layer);
			}

		});
	}
	console.log(style);
	map.setStyle(style);
	current_type = type;


}


// Usage:
//   var data = { 'first name': 'George', 'last name': 'Jetson', 'age': 110 };
//   var querystring = EncodeQueryData(data);
// 
function EncodeQueryData(data)
{
   var ret = [];
   for (var d in data)
      ret.push(encodeURIComponent(d) + "=" + encodeURIComponent(data[d]));
   return ret.join("&");
}

var full_url = request_url;

var mapbox_style = {
        "version": 8,
        "sources": {
            "simple-tiles": {
                "type": "raster",
				"tiles": [ "http://a.tiles.mapbox.com/v3/conveyal.hml987j0/{z}/{x}/{y}.png",
					"http://b.tiles.mapbox.com/v3/conveyal.hml987j0/{z}/{x}/{y}.png"
					],
            	"maxzoom": 18,
                "tileSize": 256
            },
			"perm": {
				"type": "geojson",
				"data": full_url
			}
        },
        "layers": [{
            "id": "simple-tiles",
            "type": "raster",
            "source": "simple-tiles",
            "minzoom": 0,
            "maxzoom": 18
        }]
    };

mapboxgl.accessToken = ''; //NOT needed
var tileset = 'conveyal.hml987j0';
var map = new mapboxgl.Map({
    container: 'map', // container id
    style: style,
    center: [15.65, 46.55],
    zoom: 14
});



/*
map.on('style.load', function() {
	map.addSource('perm', source);
});*/

map.on('moveend', function() {
	//on zooms lower then 13 we are visiting too many spatial index cells on a server and don't get an answer
	if (map.getZoom() < 13) {
		return;
	}
	var bbox = map.getBounds();
	var params = {
		n : bbox.getNorth(),
		s : bbox.getSouth(),
		e : bbox.getEast(),
		w : bbox.getWest(),
		detail: true //adds name, OSMID and speed as properties
	};
	//console.log(bbox);
	full_url = request_url + "?" + EncodeQueryData(params);
	console.log(full_url);
	var source = map.getSource("perm");
	source.setData(full_url);
});

function fillPopup(feature, layer) {
	if (feature.properties) {
		var prop = feature.properties;
		var pop = "<p>";
		var layer_info = layers[current_layer];
		for (var i=0; i < layer_info.length; i++) {
			pop += layer_info[i].toUpperCase();
			pop +=": ";
			pop += prop[layer_info[i]];
			pop +="<br />";
		}
		pop +="</p>";
		return pop;
	}
	return null;
}

map.on('click', function(e) {
	// query the map for the under the mouse
   	map.featuresAt(e.point, { radius: 5, includeGeometry: true }, function (err, features) {
    if (err) throw err;
    //console.log(e.point, features);
    var ids = features.map(function (feat) { return feat.properties.edge_id });
	if (ids.length == 1) {
		var pop_html = fillPopup(features[0], current_layer);
		if (pop_html != null) {
			var tooltip = new mapboxgl.Popup()
			.setLngLat(e.lngLat)
			.setHTML(pop_html)
			.addTo(map);
		}
	}


    // set the filter on the hover style layer to only select the features
    // currently under the mouse
    map.setFilter('perm-hover', [ 'all',
      [ 'in', 'edge_id' ].concat(ids)
    ]);
  });
});

//disables map rotation
map.dragRotate.disable();

//Sets map based on graph data from server
$.ajax(otp_config.hostname+"/metadata", {
	dataType: 'JSON',
	success: function(data) {
		window.map.fitBounds([
			[data.envelope.minX, data.envelope.minY],
			[data.envelope.maxX, data.envelope.maxY]
		]);
	}
});

$(function() {
	getStyle(current_type);
});
</script>

</body>
</html>
